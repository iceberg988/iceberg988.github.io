<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: dark)"><meta name="generator" content="Hexo 6.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/logo/FlamingBytes-icon-64x64-1.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/logo/FlamingBytes-icon-64x64-1.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/logo/FlamingBytes-icon-64x64-1.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" integrity="sha256-CTSx/A06dm1B063156EVh15m6Y67pAjZZaQc89LLSrU=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"www.flamingbytes.com","root":"/","images":"/images","scheme":"Mist","darkmode":true,"version":"8.18.2","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":{"enable":true,"style":"default"},"fold":{"enable":true,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script>

    <meta name="description" content="Stay hungry, stay foolish">
<meta property="og:type" content="website">
<meta property="og:title" content="FlamingBytes">
<meta property="og:url" content="https://www.flamingbytes.com/page/14/index.html">
<meta property="og:site_name" content="FlamingBytes">
<meta property="og:description" content="Stay hungry, stay foolish">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="relentlesstorm">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://www.flamingbytes.com/page/14/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"en","comments":"","permalink":"","path":"page/14/index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>FlamingBytes</title>
  







<!-- Google Adsense-->
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-8578408127828851"
     crossorigin="anonymous"></script>

<!-- Google tag (gtag.js) for analytics-->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-B8PQ47L2H0"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-B8PQ47L2H0');
</script>

  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">FlamingBytes</h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="Search" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories<span class="badge">10</span></a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags<span class="badge">103</span></a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives<span class="badge">267</span></a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="relentlesstorm"
      src="/images/logo/FlamingBytes-icon-64x64-1.png">
  <p class="site-author-name" itemprop="name">relentlesstorm</p>
  <div class="site-description" itemprop="description">Stay hungry, stay foolish</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">267</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">10</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">103</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="mailto:relentlesstorm@gmail.com" title="E-Mail → mailto:relentlesstorm@gmail.com" rel="noopener me" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>
  <div class="cc-license animated" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class="cc-opacity" rel="noopener" target="_blank"><img src="https://cdnjs.cloudflare.com/ajax/libs/creativecommons-vocabulary/2020.11.3/assets/license_badges/small/by_nc_sa.svg" alt="Creative Commons"></a>
  </div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://www.flamingbytes.com/blog/using-netstat-to-check-network-package-retransmission/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/logo/FlamingBytes-icon-64x64-1.png">
      <meta itemprop="name" content="relentlesstorm">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="FlamingBytes">
      <meta itemprop="description" content="Stay hungry, stay foolish">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | FlamingBytes">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/blog/using-netstat-to-check-network-package-retransmission/" class="post-title-link" itemprop="url">Using netstat to check network package retransmission</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-09-02 07:00:00" itemprop="dateCreated datePublished" datetime="2022-09-02T07:00:00-07:00">2022-09-02</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2023-10-22 11:28:20" itemprop="dateModified" datetime="2023-10-22T11:28:20-07:00">2023-10-22</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Tech/" itemprop="url" rel="index"><span itemprop="name">Tech</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Tech/Linux/" itemprop="url" rel="index"><span itemprop="name">Linux</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <pre><code>$ while [ 1 ]; do netstat -s | grep &#39;segments retransmited&#39; ; sleep 1; done
    2500906 segments retransmited
    2500912 segments retransmited
    2501072 segments retransmited
    2501102 segments retransmited
    2501191 segments retransmited
</code></pre>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://www.flamingbytes.com/blog/mid-autumn-festival/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/logo/FlamingBytes-icon-64x64-1.png">
      <meta itemprop="name" content="relentlesstorm">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="FlamingBytes">
      <meta itemprop="description" content="Stay hungry, stay foolish">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | FlamingBytes">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/blog/mid-autumn-festival/" class="post-title-link" itemprop="url">Mid-Autumn Festival</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-08-16 06:57:00" itemprop="dateCreated datePublished" datetime="2022-08-16T06:57:00-07:00">2022-08-16</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2023-10-22 11:28:20" itemprop="dateModified" datetime="2023-10-22T11:28:20-07:00">2023-10-22</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Young-Author/" itemprop="url" rel="index"><span itemprop="name">Young Author</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>Mid-Autumn Festival is a traditional festival in Chinese culture, having its history dating to 3000 years ago. The festival is held on the 15th day of the 8th month of the lunisolar calendar. The Chinese believe that the moon is at its brightest and largest size that night.</p>
<p>There are multiple legends of the Mid-Autumn Festival, the most popular of them being the story of Hou Yi and Chang’e. The legend says that there once were 10 fiery suns raging in the sky, burning down all the plants and humans. Seeing his people suffering, Hou Yi used his bow to kill 9 of the suns. As a reward, he was given the elixir of immortality, which granted him the ability to live forever. Since he wanted to spend more time with his wife Chang’e, Hou Yi asked her to keep it safe for him. The people asked him to be their master, and he agreed to teach most of them. But one particular greedy disciple Pang Meng wanted the elixir for himself, so one day he pretended to be ill. After Hou Yi left to hunt, Pang Meng went to his house and forced Chang’e to give him the elixir. Since she couldn’t defeat him, Chang’e drank the elixir and was lifted up into the heavens, becoming the moon goddess. After returning, Hou Yi was heartbroken and offered Chang’e some fruit and cakes that she loved to eat. Since then, people have always offered the Moon Goddess fruits and moon cakes to worship the moon.</p>
<p>There are multiple ways to celebrate the Mid-Autumn Festival. The most representative way is to eat moon cakes, which often have red bean, egg yolk, five kernel, or lotus seed. Other ways include making colorful lanterns,  enjoying fire dragon dances, and worshiping the moon. These ways of celebration are believed to bring good luck.</p>
<p>In conclusion, the Mid-Autumn festival is a very important and popular festival that you don’t want to miss. It is a time for family reunion and giving gifts that both children and adults enjoy.</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://www.flamingbytes.com/blog/art-painting/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/logo/FlamingBytes-icon-64x64-1.png">
      <meta itemprop="name" content="relentlesstorm">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="FlamingBytes">
      <meta itemprop="description" content="Stay hungry, stay foolish">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | FlamingBytes">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/blog/art-painting/" class="post-title-link" itemprop="url">Art - Painting</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-08-02 07:00:00" itemprop="dateCreated datePublished" datetime="2022-08-02T07:00:00-07:00">2022-08-02</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2023-10-22 11:28:20" itemprop="dateModified" datetime="2023-10-22T11:28:20-07:00">2023-10-22</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Young-Author/" itemprop="url" rel="index"><span itemprop="name">Young Author</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p><img src="/images/drawing/IMG_20210919_133231.jpg"></p>
<p><img src="/images/drawing/IMG_20210919_133455.jpg"></p>
<p><img src="/images/drawing/IMG_20210919_134653.jpg"></p>
<p><img src="/images/drawing/IMG_20210919_134701.jpg"></p>
<p><img src="/images/drawing/IMG_20210919_134713.jpg"></p>
<p><img src="/images/drawing/IMG_20210919_134810.jpg"></p>
<p><img src="/images/drawing/IMG_20210919_134814.jpg"></p>
<p><img src="/images/drawing/IMG_20210919_140051.jpg"></p>
<p><img src="/images/drawing/IMG_20210925_143353.jpg"></p>
<p><img src="/images/drawing/IMG_20211002_170353__01.jpg"></p>
<p><img src="/images/drawing/IMG_20211024_152425.jpg"></p>
<p><img src="/images/drawing/IMG_20211024_152501.jpg"></p>
<p><img src="/images/drawing/IMG_0336.jpeg"></p>
<p><img src="/images/drawing/IMG_0337.jpeg"></p>
<p><img src="/images/drawing/IMG_0338.jpeg"></p>
<p><img src="/images/drawing/IMG_0339.jpeg"></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://www.flamingbytes.com/blog/compile-linux-kernel-on-centos/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/logo/FlamingBytes-icon-64x64-1.png">
      <meta itemprop="name" content="relentlesstorm">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="FlamingBytes">
      <meta itemprop="description" content="Stay hungry, stay foolish">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | FlamingBytes">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/blog/compile-linux-kernel-on-centos/" class="post-title-link" itemprop="url">Compile Linux kernel on CentOS</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-07-19 07:00:00" itemprop="dateCreated datePublished" datetime="2022-07-19T07:00:00-07:00">2022-07-19</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2023-10-22 11:28:20" itemprop="dateModified" datetime="2023-10-22T11:28:20-07:00">2023-10-22</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Tech/" itemprop="url" rel="index"><span itemprop="name">Tech</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Tech/Linux/" itemprop="url" rel="index"><span itemprop="name">Linux</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="Build-preparations"><a href="#Build-preparations" class="headerlink" title="Build preparations"></a>Build preparations</h2><p>To perform a successful kernel build, the following packages need to be installed:</p>
<ul>
<li>yum groupinstall “Development Tools”</li>
<li>yum install ncurses-devel</li>
<li>yum install qt3-devel (This is only necessary if you wish to use “make xconfig” instead of “make gconfig” or “make menuconfig”.) In the following example, we use “make menuconfig”.</li>
<li>yum install hmaccalc zlib-devel binutils-devel elfutils-libelf-devel</li>
</ul>
<h2 id="Download-kernel-source"><a href="#Download-kernel-source" class="headerlink" title="Download kernel source"></a>Download kernel source</h2><p>Download kernel source from <a target="_blank" rel="noopener" href="https://www.kernel.org/">The Linux kernel archives</a>.</p>
<pre><code>[root@host1 ~]# mkdir ~/rpmbuild/
[root@host1 ~]# cd ~/rpmbuild/
[root@host1 rpmbuild]# pwd
/root/rpmbuild

[root@host1 rpmbuild]# wget https://cdn.kernel.org/pub/linux/kernel/v5.x/linux-5.18.12.tar.xz
[root@host1 rpmbuild]# tar xvf linux-5.18.12.tar.xz
[root@host1 rpmbuild]# cd linux-5.18.12
</code></pre>
<h2 id="Configure-the-new-kernel"><a href="#Configure-the-new-kernel" class="headerlink" title="Configure the new kernel"></a>Configure the new kernel</h2><p><strong>Note</strong>: If you do not intend to modify the distributed kernel configuration file, you may omit this section.</p>
<p>Copy the config file from the current running kernel to the new kernel source directory:</p>
<pre><code>[root@host1 linux-5.18.12]# cat /etc/centos-release
CentOS Linux release 7.9.2009 (Core)

[root@host1 linux-5.18.12]# uname -r
5.18.10-1.el7.elrepo.x86_64

[root@host1 linux-5.18.12]# cp /boot/config-5.18.10-1.el7.elrepo.x86_64 .config
</code></pre>
<p>Modify the kernel config with the “make menuconfig” command:</p>
<pre><code>[root@host1 linux-5.18.12]# make menuconfig
  HOSTCC  scripts/basic/fixdep
  UPD     scripts/kconfig/mconf-cfg
  HOSTCC  scripts/kconfig/mconf.o
  HOSTCC  scripts/kconfig/lxdialog/checklist.o
  HOSTCC  scripts/kconfig/lxdialog/inputbox.o
  HOSTCC  scripts/kconfig/lxdialog/menubox.o
  HOSTCC  scripts/kconfig/lxdialog/textbox.o
  HOSTCC  scripts/kconfig/lxdialog/util.o
  HOSTCC  scripts/kconfig/lxdialog/yesno.o
  HOSTCC  scripts/kconfig/confdata.o
  HOSTCC  scripts/kconfig/expr.o
  LEX     scripts/kconfig/lexer.lex.c
  YACC    scripts/kconfig/parser.tab.[ch]
  HOSTCC  scripts/kconfig/lexer.lex.o
  HOSTCC  scripts/kconfig/menu.o
  HOSTCC  scripts/kconfig/parser.tab.o
  HOSTCC  scripts/kconfig/preprocess.o
  HOSTCC  scripts/kconfig/symbol.o
  HOSTCC  scripts/kconfig/util.o
  HOSTLD  scripts/kconfig/mconf


*** End of the configuration.
*** Execute &#39;make&#39; to start the build or try &#39;make help&#39;.
</code></pre>
<p>The following window should be seen. You can enable or disable certain kernel features as needed. Here we just leave everything the defaults.</p>
<p><img src="/images/config-kernel-1.png" alt="Image"></p>
<p>Once it’s configured, go to “&lt; Save &gt;” and press “&lt; Ok &gt;” to save it.</p>
<p><img src="/images/config-kernel-2.png" alt="Image"></p>
<p>Now we can open the file “.config” to verify the content based on the previous modification.</p>
<pre><code>[root@host1 linux-5.18.12]# head .config
#
# Automatically generated file; DO NOT EDIT.
# Linux/x86 5.18.12 Kernel Configuration
#
CONFIG_CC_VERSION_TEXT=&quot;gcc (GCC) 7.3.1 20180303 (Red Hat 7.3.1-5)&quot;
CONFIG_CC_IS_GCC=y
CONFIG_GCC_VERSION=70301
CONFIG_CLANG_VERSION=0
CONFIG_AS_IS_GNU=y
CONFIG_AS_VERSION=22800
</code></pre>
<h2 id="Install-multiple-gcc-versions"><a href="#Install-multiple-gcc-versions" class="headerlink" title="Install multiple gcc versions"></a>Install multiple gcc versions</h2><p>Depending on the gcc version included in the system, you may encounter errors when to run “make menuconfig” which requires a higher version of gcc.</p>
<pre><code>[root@host1 linux-5.18.12]# make menuconfig
&lt;...&gt;
***
*** Compiler is too old.
***   Your GCC version:    4.8.5
***   Minimum GCC version: 5.1.0
***
scripts/Kconfig.include:44: Sorry, this compiler is not supported.
</code></pre>
<p><a target="_blank" rel="noopener" href="https://www.softwarecollections.org/en/">Software Collections</a>, also known as SCL is a community project that allows you to build, install, and use multiple versions of software on the same system, without affecting system default packages. By enabling Software Collections, you gain access to the newer versions of programming languages and services which are not available in the core repositories. The SCL repositories provide a package named Developer Toolset, which includes newer versions of the GNU Compiler Collection, and other development and debugging tools.</p>
<p>To check the already installed gcc version:</p>
<pre><code>[root@host1 linux-5.18.12]# gcc --version
gcc (GCC) 4.8.5 20150623 (Red Hat 4.8.5-44)
Copyright (C) 2015 Free Software Foundation, Inc.
This is free software; see the source for copying conditions.  There is NO
warranty; not even for MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
</code></pre>
<p>To install the newer version of gcc:</p>
<pre><code>[root@host1 linux-5.18.12]# sudo yum install centos-release-scl
[root@host1 linux-5.18.12]# sudo yum install devtoolset-7
</code></pre>
<p>To access gcc version 7, a new shell instance using the Software Collection scl tool needs to be launched.</p>
<pre><code>[root@host1 linux-5.18.12]# scl enable devtoolset-7 bash
149 packages can be updated.
0 updates are security updates.

[root@host1 linux-5.18.12]# gcc --version
gcc (GCC) 7.3.1 20180303 (Red Hat 7.3.1-5)
Copyright (C) 2017 Free Software Foundation, Inc.
This is free software; see the source for copying conditions.  There is NO
warranty; not even for MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.

[root@host1 linux-5.18.12]# make menuconfig
</code></pre>
<p>For more detail, please refer to <a target="_blank" rel="noopener" href="https://www.softwarecollections.org/en/scls/rhscl/devtoolset-7/">Developer Toolset 7</a> or a different version.</p>
<h2 id="Compile-the-kernel"><a href="#Compile-the-kernel" class="headerlink" title="Compile the kernel"></a>Compile the kernel</h2><p>Before start compiling the new kernel, make sure more than 20GB of free space on the filesystem is available.</p>
<pre><code>[root@host1 linux-5.18.12]# df -h | egrep &quot;Filesystem|root&quot;
Filesystem                 Size  Used Avail Use% Mounted on
/dev/mapper/vgroot-lvroot  1.5T   21G  1.4T   2% /
</code></pre>
<p>Now, we can compile the kernel. We run the compilation process in the background since it takes long time.</p>
<pre><code>[root@host1 linux-5.18.12]# nohup make rpm-pkg &amp;
[root@host1 linux-5.18.12]# tail -f nohup.out
[root@host1 linux-5.18.12]# more nohup.out
  SYNC    include/config/auto.conf.cmd
  HOSTCC  scripts/kconfig/conf.o
  HOSTLD  scripts/kconfig/conf
  UPD     include/config/kernel.release
make clean
sh ./scripts/package/mkspec &gt;./kernel.spec
  TAR     kernel-5.18.12.tar.gz
rpmbuild  --target x86_64 -ta kernel-5.18.12.tar.gz \
--define=&#39;_smp_mflags %&#123;nil&#125;&#39;
Building target platforms: x86_64
Building for target x86_64
Executing(%prep): /bin/sh -e /var/tmp/rpm-tmp.nOAadM
</code></pre>
<p>Note that the kernel.spec file is created automatically by “sh .&#x2F;scripts&#x2F;package&#x2F;mkspec &gt;.&#x2F;kernel.spec”.</p>
<p>Upon completion, the following output shows the location of the generated rpms.</p>
<pre><code>[root@host1 linux-5.18.12]# tail -15 nohup.out
Obsoletes: kernel-headers
Processing files: kernel-devel-5.18.12-1.x86_64
Provides: kernel-devel = 5.18.12-1 kernel-devel(x86-64) = 5.18.12-1
Requires(rpmlib): rpmlib(FileDigests) &lt;= 4.6.0-1 rpmlib(PayloadFilesHavePrefix) &lt;= 4.0-1 rpmlib(CompressedFileNames) &lt;= 3.0.4-1
Checking for unpackaged file(s): /usr/lib/rpm/check-files /root/rpmbuild/BUILDROOT/kernel-5.18.12-1.x86_64
Wrote: /root/rpmbuild/SRPMS/kernel-5.18.12-1.src.rpm
Wrote: /root/rpmbuild/RPMS/x86_64/kernel-5.18.12-1.x86_64.rpm
Wrote: /root/rpmbuild/RPMS/x86_64/kernel-headers-5.18.12-1.x86_64.rpm
Wrote: /root/rpmbuild/RPMS/x86_64/kernel-devel-5.18.12-1.x86_64.rpm
Executing(%clean): /bin/sh -e /var/tmp/rpm-tmp.DiAd0f
+ umask 022
+ cd /root/rpmbuild/BUILD
+ cd kernel-5.18.12
+ rm -rf /root/rpmbuild/BUILDROOT/kernel-5.18.12-1.x86_64
+ exit 0
</code></pre>
<p>To check the generated kernel rpms:</p>
<pre><code>[root@host1 rpmbuild]# pwd
/root/rpmbuild

[root@host1 rpmbuild]# ls RPMS/x86_64/
kernel-5.18.12-1.x86_64.rpm  kernel-devel-5.18.12-1.x86_64.rpm  kernel-headers-5.18.12-1.x86_64.rpm
[root@host1 rpmbuild]# ls SRPMS/
kernel-5.18.12-1.src.rpm
</code></pre>
<h2 id="Install-the-new-kernel"><a href="#Install-the-new-kernel" class="headerlink" title="Install the new kernel"></a>Install the new kernel</h2><p>Now you can run the following command to install the rpm packages:</p>
<pre><code>[root@host1 rpmbuild]# rpm -iUv ~/rpmbuild/RPMS/x86_64/*.rpm
</code></pre>
<p>Once the installation is complete, run the following command to reboot the system:</p>
<pre><code>[root@host1 rpmbuild]# reboot
</code></pre>
<p>Once the system starts, run the following command to check the kernel version:</p>
<pre><code>[root@host1 ~]# uname -r
</code></pre>
<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><ul>
<li><a target="_blank" rel="noopener" href="https://wiki.centos.org/HowTos/Custom_Kernel">Build a custom kernel on CentOS</a></li>
<li><a target="_blank" rel="noopener" href="https://linuxhint.com/compile-linux-kernel-centos7/">Compile Linux kernel on CentOS 7</a></li>
<li><a target="_blank" rel="noopener" href="https://linuxize.com/post/how-to-install-gcc-compiler-on-centos-7/">How to install GCC compiler on CentOS 7</a></li>
<li><a target="_blank" rel="noopener" href="https://www.kernel.org/">Linux kernel arhives</a></li>
<li><a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/latest/source">Linux kernel source code</a></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://www.flamingbytes.com/blog/deploy-systemtap-on-multiple-systems/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/logo/FlamingBytes-icon-64x64-1.png">
      <meta itemprop="name" content="relentlesstorm">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="FlamingBytes">
      <meta itemprop="description" content="Stay hungry, stay foolish">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | FlamingBytes">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/blog/deploy-systemtap-on-multiple-systems/" class="post-title-link" itemprop="url">Deploy systemtap on multiple systems</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-07-17 07:00:00" itemprop="dateCreated datePublished" datetime="2022-07-17T07:00:00-07:00">2022-07-17</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2023-10-22 11:28:20" itemprop="dateModified" datetime="2023-10-22T11:28:20-07:00">2023-10-22</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Tech/" itemprop="url" rel="index"><span itemprop="name">Tech</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Tech/Linux/" itemprop="url" rel="index"><span itemprop="name">Linux</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>Normally, SystemTap scripts can only be run on systems where SystemTap is deployed together with the following required kernel packages.</p>
<ul>
<li>kernel-devel-$(uname -r)</li>
<li>kernel-debuginfo-$(uname -r)</li>
<li>kernel-debuginfo-common-$(uname -m)-$(uname -r)</li>
</ul>
<p>In the case that it’s neither feasible nor desired to install the denpendent packages on all the target systems. Using cross-instrumentation can work around. Cross-instrumentation is the process of generating SystemTap instrumentation modules from a SystemTap script on one system to be used on another system. This process offers the following benefits:</p>
<ul>
<li>The kernel information packages for various machines can be installed on a single host machine.</li>
<li>Each target machine only needs one package to be installed to use the generated SystemTap instrumentation module: systemtap-runtime.</li>
</ul>
<p>To build the instrumentation module, do the following on the host which has the dependent kernel packages installed:</p>
<pre><code>[root@host1 ~]# uname -r
5.18.10-1.el7.elrepo.x86_64

[root@host1 ~]# rpm -qa | egrep &quot;kernel-debug|kernel-devel|systemtap&quot;
systemtap-client-4.0-13.el7.x86_64
systemtap-runtime-4.0-13.el7.x86_64
kernel-devel-3.10.0-1160.el7.x86_64
systemtap-devel-4.0-13.el7.x86_64
kernel-debuginfo-common-x86_64-3.10.0-1160.el7.x86_64
kernel-debuginfo-3.10.0-1160.el7.x86_64
systemtap-4.0-13.el7.x86_64

[root@host1 ~]# stap -r 3.10.0-1160.el7.x86_64 -e &#39;probe vfs.read &#123;printf(&quot;read performed\n&quot;);&#125; probe timer.s(5)&#123;exit()&#125;&#39; -m ported_stap -p4
ported_stap.ko

[root@host1 ~]# file ported_stap.ko
ported_stap.ko: ELF 64-bit LSB relocatable, x86-64, version 1 (SYSV), BuildID[sha1]=1ad58adccafc9bf629f1edcbc285e9090e84dc35, not stripped

[root@host1 ~]# ls -la ported_stap.ko
-rw-r--r-- 1 root root 103608 Jul 20 22:33 ported_stap.ko
</code></pre>
<p>Once the instrumentation module is compiled, copy it to the target system and then run it using:</p>
<pre><code>[root@host1 ~]# scp ported_stap.ko host2:/root

[root@host2 ~]# uname -r
3.10.0-1160.el7.x86_64

[root@host2 ~]# rpm -qa | egrep &quot;kernel-debug|kernel-devel|systemtap&quot;
systemtap-runtime-4.0-13.el7.x86_64

[root@host2 ~]# staprun ported_stap.ko
read performed
read performed
read performed
&lt;...&gt;
</code></pre>
<p>When users run a SystemTap script, a kernel module is built out of that script. SystemTap then loads the module into the kernel, allowing it to extract the specified data directly from the kernel. From the following command output, it’s clear that the SystemTap kernel module is dynamically loaded during the script run.</p>
<pre><code>[root@host2 ~]# lsmod | grep ported_stap
ported_stap           139049  2
[root@host2 ~]# lsmod | grep ported_stap
[root@host2 ~]#
</code></pre>
<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><ul>
<li><a target="_blank" rel="noopener" href="https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/7/html-single/systemtap_beginners_guide/index">SystemTap beginners guide</a></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://www.flamingbytes.com/blog/using-systemtap-to-analyze-latency-of-the-kernel-module-function/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/logo/FlamingBytes-icon-64x64-1.png">
      <meta itemprop="name" content="relentlesstorm">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="FlamingBytes">
      <meta itemprop="description" content="Stay hungry, stay foolish">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | FlamingBytes">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/blog/using-systemtap-to-analyze-latency-of-the-kernel-module-function/" class="post-title-link" itemprop="url">Using systemtap to analyze latency of the kernel module function</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-07-16 07:00:00" itemprop="dateCreated datePublished" datetime="2022-07-16T07:00:00-07:00">2022-07-16</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2023-10-22 11:28:20" itemprop="dateModified" datetime="2023-10-22T11:28:20-07:00">2023-10-22</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Tech/" itemprop="url" rel="index"><span itemprop="name">Tech</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Tech/Performance/" itemprop="url" rel="index"><span itemprop="name">Performance</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>In this post, we continue to explore how to use SystemTap to analyze the latency of the kernel module function. In the following example, we want to analyze the latency of the function “nfsd_vfs_write” from the kernel module “nfsd”.</p>
<h2 id="Deploy-the-SystemTap-packages"><a href="#Deploy-the-SystemTap-packages" class="headerlink" title="Deploy the SystemTap packages"></a>Deploy the SystemTap packages</h2><p>Refer to <a href="/blog/getting-started-with-systemtap-for-linux-system-profiling/">this</a> post to deploy SystemTap and its required packages.</p>
<h2 id="Check-the-nfsd-kernel-module-info"><a href="#Check-the-nfsd-kernel-module-info" class="headerlink" title="Check the nfsd kernel module info"></a>Check the nfsd kernel module info</h2><pre><code>[root@host1 ~]# uname -r
3.10.0-1160.el7.x86_64

[root@host1 ~]# ls /lib/modules/`uname -r`/kernel/
arch  crypto  drivers  fs  kernel  lib  mm  net  sound  virt
[root@host1 ~]# ls /lib/modules/`uname -r`/kernel/fs
binfmt_misc.ko.xz  btrfs  cachefiles  ceph  cifs  cramfs  dlm  exofs  ext4  fat  fscache  fuse  gfs2  isofs  jbd2  lockd  mbcache.ko.xz  nfs  nfs_common  nfsd  nls  overlayfs  pstore  squashfs  udf  xfs

[root@host1 ~]# ls /lib/modules/`uname -r`/kernel/fs/ext4
ext4.ko.xz
[root@host1 ~]# ls /lib/modules/`uname -r`/kernel/fs/xfs
xfs.ko.xz
[root@host1 ~]# ls /lib/modules/`uname -r`/kernel/fs/btrfs
btrfs.ko.xz
[root@host1 ~]# ls /lib/modules/`uname -r`/kernel/fs/nfs
blocklayout  filelayout  flexfilelayout  nfs.ko.xz  nfsv3.ko.xz  nfsv4.ko.xz  objlayout


[root@host1 ~]# lsmod | grep &quot;nfsd &quot;
nfsd                  351321  13
[root@host1 ~]# modinfo nfsd
filename:       /lib/modules/3.10.0-1160.el7.x86_64/kernel/fs/nfsd/nfsd.ko.xz
license:        GPL
author:         Olaf Kirch &lt;okir@monad.swb.de&gt;
alias:          fs-nfsd
retpoline:      Y
rhelversion:    7.9
srcversion:     61A6390CD82AA4A7492CB06
depends:        auth_rpcgss,sunrpc,grace,lockd,nfs_acl
intree:         Y
vermagic:       3.10.0-1160.el7.x86_64 SMP mod_unload modversions
signer:         CentOS Linux kernel signing key
sig_key:        E1:FD:B0:E2:A7:E8:61:A1:D1:CA:80:A2:3D:CF:0D:BA:3A:A4:AD:F5
sig_hashalgo:   sha256
parm:           cltrack_prog:Path to the nfsdcltrack upcall program (string)
parm:           cltrack_legacy_disable:Disable legacy recoverydir conversion. Default: false (bool)
parm:           nfs4_disable_idmapping:Turn off server&#39;s NFSv4 idmapping when using &#39;sec=sys&#39; (bool)

[root@host1 ~]# cat /proc/kallsyms |  egrep -i -w &quot;nfsd_vfs_write&quot;
ffffffffc094fdd0 t nfsd_vfs_write	[nfsd] 
</code></pre>
<h2 id="SystemTap-script"><a href="#SystemTap-script" class="headerlink" title="SystemTap script"></a>SystemTap script</h2><p>In the following SystemTap script, we have implemented</p>
<ul>
<li><p>a probe to detect the kernel module “nfsd” and its function “nfsd_vfs_write”</p>
</li>
<li><p>a probe to detect the return of the function “nfsd_vfs_write”</p>
</li>
<li><p>handlers to get the execname, pid, tid and timestamp in each probe function</p>
</li>
<li><p>a probe as timer(5 seconds tracing)</p>
</li>
<li><p>a probe “end” to analyze the collected runtime of the function “nfsd_vfs_write” in the end of tracing</p>
<p>  [root@host1 ~]# cat nfs_trace.stp<br>  global count<br>  global start_t,diff_t[1000000]</p>
<p>  probe module(“nfsd”).function(“nfsd_vfs_write”){<br>  count++<br>  e &#x3D; execname()<br>  p &#x3D; pid()<br>  t &#x3D; tid()<br>  start_t[e,p,t] &#x3D; gettimeofday_us()<br>  }</p>
<p>  probe module(“nfsd”).function(“nfsd_vfs_write”).return {<br>  e &#x3D; execname()<br>  p &#x3D; pid()<br>  t &#x3D; tid()<br>  start_ts &#x3D; start_t[e,p,t]<br>  end_ts &#x3D; gettimeofday_us()<br>  if(start_ts&gt;0)<br>      diff_t[e,p,t,start_ts] &#x3D; end_ts - start_ts<br>  }</p>
<p>  probe timer.s(5){exit()}</p>
<p>  probe end{<br>  count&#x3D;1<br>  total_time&#x3D;0<br>  foreach([e,p,t,ts] in diff_t){<br>      printf(“nfsd_vfs_write(%d %s %d %d %d) call time: %d\n”,count,e,p,t,ts,diff_t[e,p,t,ts])<br>      count++<br>      total_time+&#x3D;diff_t[e,p,t,ts]<br>  }<br>  count–<br>  printf(“nfsd_vfs_write total call time(us): %d\n”,total_time)<br>  printf(“nfsd_vfs_write calls: %d\n”,count)<br>  printf(“nfsd_vfs_write average call time(us): %d\n”,total_time&#x2F;count)<br>  }</p>
</li>
</ul>
<h2 id="Run-the-SystemTap-script"><a href="#Run-the-SystemTap-script" class="headerlink" title="Run the SystemTap script"></a>Run the SystemTap script</h2><pre><code>[root@host1 ~]# cat stp.sh
runid=$1
sleep 10
stap -D MAXACTION=1000000 nfs_trace.stp &gt; nfs_trace.$&#123;runid&#125;.out

[root@host1 ~]# ./stp.sh kernel-3.10-run1
</code></pre>
<p>Note that, the script will wait for 10 seconds before tracing. This is to make sure the network workload to be monitored will be running stable.</p>
<h2 id="Get-the-tracing-result"><a href="#Get-the-tracing-result" class="headerlink" title="Get the tracing result"></a>Get the tracing result</h2><pre><code>[root@host1 ~]# cat stp_3.10/nfs_trace.1.out | head -3
nfsd_vfs_write(1 nfsd 3597 3597 1658189341055849) call time: 139
nfsd_vfs_write(2 nfsd 3598 3598 1658189341055864) call time: 136
nfsd_vfs_write(3 nfsd 3596 3596 1658189341055977) call time: 149
[root@host1 ~]# cat stp_3.10/nfs_trace.1.out | tail -5
nfsd_vfs_write(116340 nfsd 3595 3595 1658189346055536) call time: 182
nfsd_vfs_write(116341 nfsd 3598 3598 1658189346055621) call time: 237
nfsd_vfs_write total call time(us): 23050967
nfsd_vfs_write calls: 116341
nfsd_vfs_write average call time(us): 198
</code></pre>
<p>As we can see, there are totally 116341 calls for the function “nfsd_vfs_write” and the average call time is 198 us. This gives us a clear sense of the function call latency so that we can compare the same for different system configurations(e.g. different kernel versions).</p>
<h2 id="SystemTap-runtime-errors"><a href="#SystemTap-runtime-errors" class="headerlink" title="SystemTap runtime errors"></a>SystemTap runtime errors</h2><p>When we run the SystemTap script, we added a option “-D MAXACTION&#x3D;1000000” to fix the following runtime error.</p>
<pre><code>[root@host1 ~]# stap nfs_trace.stp &gt; nfs_trace.out
ERROR: MAXACTION exceeded near identifier &#39;printf&#39; at nfs_trace.stp:27:3
WARNING: Number of errors: 1, skipped probes: 0
WARNING: /usr/bin/staprun exited with status: 1
Pass 5: run failed.  [man error::pass5]
</code></pre>
<p>What does “⁠MAXACTION exceeded” mean?</p>
<blockquote>
<p>The probe handler attempted to execute too many statements in the probe handler. The default number of actions allowed in a probe handler is 1000.</p>
</blockquote>
<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><ul>
<li><a target="_blank" rel="noopener" href="https://sourceware.org/systemtap/SystemTap_Beginners_Guide/">https://sourceware.org/systemtap/SystemTap_Beginners_Guide&#x2F;</a></li>
<li><a target="_blank" rel="noopener" href="https://sourceware.org/systemtap/examples/">https://sourceware.org/systemtap/examples/</a></li>
<li><a target="_blank" rel="noopener" href="https://sourceware.org/systemtap/SystemTap_Beginners_Guide/errors.html">https://sourceware.org/systemtap/SystemTap_Beginners_Guide&#x2F;errors.html</a></li>
<li><a target="_blank" rel="noopener" href="https://sourceware.org/systemtap/SystemTap_Beginners_Guide/runtimeerror.html">https://sourceware.org/systemtap/SystemTap_Beginners_Guide&#x2F;runtimeerror.html</a></li>
<li><a target="_blank" rel="noopener" href="https://mediatemple.net/blog/legacy/wrangling-nsf-load-with-systemtap/">https://mediatemple.net/blog/legacy/wrangling-nsf-load-with-systemtap/</a></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://www.flamingbytes.com/blog/getting-started-with-systemtap-for-linux-system-profiling/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/logo/FlamingBytes-icon-64x64-1.png">
      <meta itemprop="name" content="relentlesstorm">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="FlamingBytes">
      <meta itemprop="description" content="Stay hungry, stay foolish">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | FlamingBytes">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/blog/getting-started-with-systemtap-for-linux-system-profiling/" class="post-title-link" itemprop="url">Getting started with systemtap for Linux system profiling</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-07-15 07:00:00" itemprop="dateCreated datePublished" datetime="2022-07-15T07:00:00-07:00">2022-07-15</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2023-10-22 11:28:20" itemprop="dateModified" datetime="2023-10-22T11:28:20-07:00">2023-10-22</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Tech/" itemprop="url" rel="index"><span itemprop="name">Tech</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Tech/Performance/" itemprop="url" rel="index"><span itemprop="name">Performance</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="Intro-to-SystemTap"><a href="#Intro-to-SystemTap" class="headerlink" title="Intro to SystemTap"></a>Intro to SystemTap</h2><p>SystemTap is a tracing and probing tool that allows users to study and monitor the activities of the operating system (particularly, the kernel) in fine detail. It provides information similar to the output of tools like netstat, ps, top, and iostat; however, SystemTap is designed to provide more filtering and analysis options for collected information.</p>
<p>SystemTap can be used by system administrators as a performance monitoring tool for Red Hat Enterprise Linux 5 or later. It is most useful when other similar tools cannot precisely pinpoint a bottleneck in the system, thus requiring a deep analysis of system activity. In the same manner, application developers can also use SystemTap to monitor, in fine detail, how their application behaves within the Linux system.</p>
<p>SystemTap was originally developed to provide functionality for Red Hat Enterprise Linux similar to previous Linux probing tools such as dprobes and the Linux Trace Toolkit. SystemTap aims to supplement the existing suite of Linux monitoring tools by providing users with the infrastructure to track kernel activity. In addition, SystemTap combines this capability with two attributes:</p>
<ul>
<li>Flexibility: SystemTap’s framework allows users to develop simple scripts for investigating and monitoring a wide variety of kernel functions, system calls, and other events that occur in kernel space. With this, SystemTap is not so much a tool as it is a system that allows you to develop your own kernel-specific forensic and monitoring tools.</li>
<li>Ease-of-Use: as mentioned earlier, SystemTap allows users to probe kernel-space events without having to resort to the lengthy instrument, recompile, install, and reboot the kernel process.</li>
</ul>
<h2 id="Understanding-how-SystemTap-works"><a href="#Understanding-how-SystemTap-works" class="headerlink" title="Understanding how SystemTap works"></a>Understanding how SystemTap works</h2><p>SystemTap allows users to write and reuse simple scripts to deeply examine the activities of a running Linux system. These scripts can be designed to extract data, filter it, and summarize it quickly (and safely), enabling the diagnosis of complex performance (or even functional) problems.</p>
<p>The essential idea behind a SystemTap script is to name events, and to give them handlers. When SystemTap runs the script, SystemTap monitors for the event; once the event occurs, the Linux kernel then runs the handler as a quick sub-routine and then resumes its normal operation.</p>
<p>There are several kinds of events; entering or exiting a function, timer expiration, session termination, etc. A handler is a series of script language statements that specify the work to be done whenever the event occurs. This work normally includes extracting data from the event context, storing them into internal variables, and printing results.</p>
<h2 id="Setting-up-SystemTap-and-its-required-kernel-packages"><a href="#Setting-up-SystemTap-and-its-required-kernel-packages" class="headerlink" title="Setting up SystemTap and its required kernel packages"></a>Setting up SystemTap and its required kernel packages</h2><p>To deploy SystemTap, SystemTap packages along with the corresponding set of -devel, -debuginfo and -debuginfo-common-arch packages for the kernel need to be installed. To use SystemTap on more than one kernel where a system has multiple kernels installed, install the -devel and -debuginfo packages for each of those kernel versions.</p>
<p>SystemTap needs information about the kernel in order to place instrumentation in it (probe it). This information, which allows SystemTap to generate the code for the instrumentation, is contained in the matching kernel-devel, kernel-debuginfo, and kernel-debuginfo-common-arch packages.</p>
<p>To install SystemTap packages:</p>
<pre><code>[root@host1 ~]# cat /etc/centos-release
CentOS Linux release 7.9.2009 (Core)
[root@host1 ~]# uname -r
3.10.0-1160.el7.x86_64

[root@host1 ~]# yum install -y systemtap systemtap-runtime

[root@host1 ~]# rpm -qa | grep systemtap
systemtap-runtime-4.0-13.el7.x86_64
systemtap-devel-4.0-13.el7.x86_64
systemtap-4.0-13.el7.x86_64
systemtap-client-4.0-13.el7.x86_64
</code></pre>
<p>To install devel and debuginfo packages in CentOS(set to enabled&#x3D;1):</p>
<pre><code>[root@host1 ~]# vim /etc/yum.repos.d/CentOS-Debuginfo.repo
[base-debuginfo]
name=CentOS-7 - Debuginfo
baseurl=http://debuginfo.centos.org/7/$basearch/
gpgcheck=1
gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-CentOS-Debug-7
enabled=1

[root@host1 ~]# yum install -y kernel-devel-$(uname -r) \
&gt; kernel-debuginfo-$(uname -r) \
&gt; kernel-debuginfo-common-$(uname -m)-$(uname -r)

[root@host1 ~]# rpm -qa | grep debuginfo
kernel-debuginfo-common-x86_64-3.10.0-1160.el7.x86_64
kernel-debuginfo-3.10.0-1160.el7.x86_64
</code></pre>
<p>The devel package was not installed successfully since it’s not available in the existing CentOS repository. It might be fixed by adding the expected repository for yum installation. The devel package is required by SystemTap otherwise the following error is seen.</p>
<pre><code>[root@host1 ~]# stap -v -e &#39;probe vfs.read &#123;printf(&quot;read performed\n&quot;); exit()&#125;&#39;
Checking &quot;/lib/modules/3.10.0-1160.el7.x86_64/build/.config&quot; failed with error: No such file or directory
Incorrect version or missing kernel-devel package, use: yum install kernel-devel-3.10.0-1160.el7.x86_64
</code></pre>
<p>Here we just install it directly from the downloaded format as below.</p>
<pre><code>[root@host1 ~]# wget https://rpmfind.net/linux/centos/7.9.2009/os/x86_64/Packages/kernel-devel-3.10.0-1160.el7.x86_64.rpm

[root@host1 ~]# rpm -ivh kernel-devel-3.10.0-1160.el7.x86_64.rpm

[root@host1 ~]# rpm -qa | grep kernel | grep  3.10.0
kernel-devel-3.10.0-1160.el7.x86_64
kernel-tools-libs-3.10.0-1160.el7.x86_64
kernel-tools-3.10.0-1160.el7.x86_64
kernel-debuginfo-common-x86_64-3.10.0-1160.el7.x86_64
kernel-debuginfo-3.10.0-1160.el7.x86_64
kernel-headers-3.10.0-1160.59.1.el7.x86_64
kernel-3.10.0-1160.el7.x86_64
</code></pre>
<p>To verify the SystemTap setup again:</p>
<pre><code>[root@host1 ~]# stap -v -e &#39;probe vfs.read &#123;printf(&quot;read performed\n&quot;); exit()&#125;&#39;
Pass 1: parsed user script and 474 library scripts using 271960virt/69264res/3504shr/65852data kb, in 640usr/30sys/672real ms.
Pass 2: analyzed script: 1 probe, 1 function, 7 embeds, 0 globals using 439304virt/232180res/4884shr/233196data kb, in 2180usr/950sys/2977real ms.
Pass 3: translated to C into &quot;/tmp/stap6kYO8U/stap_cc0f60b74db3020f09599659b9758c89_2771_src.c&quot; using 439304virt/232436res/5140shr/233196data kb, in 10usr/50sys/67real ms.
Pass 4: compiled C into &quot;stap_cc0f60b74db3020f09599659b9758c89_2771.ko&quot; in 8040usr/1720sys/9477real ms.
Pass 5: starting run.
read performed
Pass 5: run completed in 30usr/90sys/442real ms.
</code></pre>
<h2 id="SystemTap-scripts"><a href="#SystemTap-scripts" class="headerlink" title="SystemTap scripts"></a>SystemTap scripts</h2><p>For the most part, SystemTap scripts are the foundation of each SystemTap session. SystemTap scripts instruct SystemTap on what type of information to collect, and what to do once that information is collected. SystemTap scripts are made up of two components: events and handlers. Once a SystemTap session is underway, SystemTap monitors the operating system for the specified events and executes the handlers as they occur.</p>
<p>SystemTap scripts allow insertion of the instrumentation code without recompilation of the code and allows more flexibility with regard to handlers. Events serve as the triggers for handlers to run; handlers can be specified to record specified data and print it in a certain manner.</p>
<p>SystemTap scripts use the .stp file extension and contains probes written in the following format:</p>
<pre><code>probe event &#123;statements&#125;
</code></pre>
<p>Systemtap allows you to write functions to factor out code to be used by a number of probes. Thus, rather than repeatedly writing the same series of statements in multiple probes, you can just place the instructions in a function, as in:</p>
<pre><code>function function_name(arguments)&#123;statements&#125;
probe event &#123;function_name(arguments)&#125;
</code></pre>
<p>The statements in function_name are executed when the probe for event executes. The arguments are optional values passed into the function.</p>
<h2 id="Running-SystemTap-Scripts"><a href="#Running-SystemTap-Scripts" class="headerlink" title="Running SystemTap Scripts"></a>Running SystemTap Scripts</h2><p>SystemTap scripts are run through the command stap. stap can run SystemTap scripts from the standard input or from a file.</p>
<p>We have seen how to run SystemTap from the standard input when we tried to verify the installation in previous section.</p>
<p>We can also run it from a file as below.</p>
<pre><code>[root@host1 ~]# cat runfromfile.stp
probe vfs.read &#123;
    printf(&quot;read performed\n&quot;);
    exit()
&#125;

[root@host1 ~]# stap runfromfile.stp
read performed
</code></pre>
<p>At this point, we know what is SystemTap and how to deploy it. We will explore more meaningful usage of it in future posts.</p>
<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><ul>
<li><a target="_blank" rel="noopener" href="https://sourceware.org/systemtap/SystemTap_Beginners_Guide/">https://sourceware.org/systemtap/SystemTap_Beginners_Guide&#x2F;</a></li>
<li><a target="_blank" rel="noopener" href="https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/7/html-single/systemtap_beginners_guide/index#introduction">https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux&#x2F;7&#x2F;html-single&#x2F;systemtap_beginners_guide&#x2F;index#introduction</a></li>
<li><a target="_blank" rel="noopener" href="https://pkgs.org/download/kernel">https://pkgs.org/download/kernel</a></li>
<li><a target="_blank" rel="noopener" href="https://pkgs.org/download/kernel-devel">https://pkgs.org/download/kernel-devel</a></li>
<li><a target="_blank" rel="noopener" href="https://linux.cc.iitk.ac.in/mirror/centos/elrepo/kernel/el7/x86_64/RPMS/">https://linux.cc.iitk.ac.in/mirror/centos/elrepo/kernel/el7/x86_64&#x2F;RPMS&#x2F;</a></li>
<li><a target="_blank" rel="noopener" href="https://rpmfind.net/linux/rpm2html/search.php?query=kernel-devel">https://rpmfind.net/linux/rpm2html/search.php?query=kernel-devel</a></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://www.flamingbytes.com/blog/using-ftrace-to-analyze-latency-of-the-kernel-module-function/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/logo/FlamingBytes-icon-64x64-1.png">
      <meta itemprop="name" content="relentlesstorm">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="FlamingBytes">
      <meta itemprop="description" content="Stay hungry, stay foolish">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | FlamingBytes">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/blog/using-ftrace-to-analyze-latency-of-the-kernel-module-function/" class="post-title-link" itemprop="url">Using ftrace to analyze latency of the kernel module function</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-07-14 07:00:00" itemprop="dateCreated datePublished" datetime="2022-07-14T07:00:00-07:00">2022-07-14</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2023-10-22 11:28:20" itemprop="dateModified" datetime="2023-10-22T11:28:20-07:00">2023-10-22</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Tech/" itemprop="url" rel="index"><span itemprop="name">Tech</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Tech/Performance/" itemprop="url" rel="index"><span itemprop="name">Performance</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>In this example, we study the latency of the function “nfsd_vfs_write” from kernel module “nfsd”.</p>
<h2 id="ftrace-configuration"><a href="#ftrace-configuration" class="headerlink" title="ftrace configuration"></a>ftrace configuration</h2><p>The following ftrace options are used in this example. There are 8 nfsd processes to be traced.</p>
<ul>
<li>current_tracer:  function_graph</li>
<li>pids: 3591 3592 3593 3594 3595 3596 3597 3598</li>
<li>filters: nfsd_vfs_write [nfsd]</li>
</ul>
<h2 id="ftrace-result"><a href="#ftrace-result" class="headerlink" title="ftrace result"></a>ftrace result</h2><p>From the following trace result, it helps understand the call time of the function “nfsd_vfs_write”. This can be very helpful if we need to analyze the function latency in the kernel module.</p>
<pre><code>$ cat ftrace.out | grep nfsd_vfs_write | grep &quot;nfsd_vfs_write \[nfsd\]();&quot; | head -5
  1)  ! 185.011 us  |  nfsd_vfs_write [nfsd]();
  2)  ! 161.237 us  |  nfsd_vfs_write [nfsd]();
  3)  ! 200.954 us  |  nfsd_vfs_write [nfsd]();
  4)  ! 255.285 us  |  nfsd_vfs_write [nfsd]();
  5)  ! 171.537 us  |  nfsd_vfs_write [nfsd]();
</code></pre>
<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><ul>
<li><a target="_blank" rel="noopener" href="https://www.kernel.org/doc/Documentation/trace/ftrace.txt">https://www.kernel.org/doc/Documentation/trace/ftrace.txt</a></li>
<li><a target="_blank" rel="noopener" href="https://lwn.net/Articles/365835/">https://lwn.net/Articles/365835/</a></li>
<li><a target="_blank" rel="noopener" href="https://lwn.net/Articles/366796/">https://lwn.net/Articles/366796/</a></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://www.flamingbytes.com/blog/dynamically-tracing-with-user-defined-tracepoint-in-perf/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/logo/FlamingBytes-icon-64x64-1.png">
      <meta itemprop="name" content="relentlesstorm">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="FlamingBytes">
      <meta itemprop="description" content="Stay hungry, stay foolish">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | FlamingBytes">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/blog/dynamically-tracing-with-user-defined-tracepoint-in-perf/" class="post-title-link" itemprop="url">Dynamically tracing with user-defined tracepoint in perf</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-07-13 07:00:00" itemprop="dateCreated datePublished" datetime="2022-07-13T07:00:00-07:00">2022-07-13</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2023-10-22 11:28:20" itemprop="dateModified" datetime="2023-10-22T11:28:20-07:00">2023-10-22</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Tech/" itemprop="url" rel="index"><span itemprop="name">Tech</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Tech/Performance/" itemprop="url" rel="index"><span itemprop="name">Performance</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>In this post, we are going to explore how to use <a href="/blog/perf-the-official-linux-profiler/" title="Perf - The official Linux profiler">Perf - The official Linux profiler</a> for dynamic tracing with user-defined tracepoint. When we say dynamic tracing, the kernel event(function) to be traced is not predefined in perf. Instead, we add the tracepoint event manually.</p>
<p>We will study it based on a real world nfs write performance issue.  With the 4k sequential write from fio, the throughput is much lower with newer kernel(5.x) compared to older kernel(3.x). By profiling the system, it’s clear to see the call stack and samples of nfsd are very different for the two kernel versions.</p>
<p><img src="/images/nfsd_perf_issue.png" alt="Image"></p>
<h2 id="Add-tracepoint-in-perf"><a href="#Add-tracepoint-in-perf" class="headerlink" title="Add tracepoint in perf"></a>Add tracepoint in perf</h2><p>At first look, I want to add a tracepoint for the kernel function “nfsd_vfs_write” since it appears in the main code path of nfsd for both kernel versions. But perf complains the error of “out of .text” as below.</p>
<pre><code>[root@host1 ~]# perf probe --add nfsd_vfs_write 
nfsd_vfs_write is out of .text, skip it.
  Error: Failed to add events. Reason: No such file or directory (Code: -2)
</code></pre>
<p>By checking the exported kernel symbols from &#x2F;proc&#x2F;kallsyms, the symbol type is lowercase “t” for the function “nfsd_vfs_write”.</p>
<pre><code>[root@host1 ~]# cat /proc/kallsyms |  egrep -i -w &quot;nfsd_vfs_write&quot;
ffffffffc094fdd0 t nfsd_vfs_write	[nfsd] 

[root@host1 ~]# perf probe -F | egrep -i &quot;nfsd_vfs_write$&quot;
nfsd_vfs_write
</code></pre>
<p>Based on the manual page of nm, lowercase means it is local symbol. It’s likely that the local symbol can’t be added as probe event.</p>
<blockquote>
<p>The symbol type.</p>
<blockquote>
<p>If lowercase, the symbol is usually local; if uppercase, the symbol is global (external).</p>
<p>“T” “t” The symbol is in the text (code) section.</p>
</blockquote>
</blockquote>
<p>If we still want to trace and understand the overhead for the function “nfsd_vfs_write”, ftrace is a way to go.</p>
<p>In this post, we want to discuss how to add a probe event in perf. So we try a different function “vfs_fsync_range” whose type is global symbol.</p>
<p>With the following commands, the probe for “vfs_fsync_range” is added to perf.</p>
<pre><code>[root@host1 ~]# uname -r
3.10.0-1160.el7.x86_64
[root@host1 ~]# cat /proc/kallsyms | awk &#39;&#123;if($2==&quot;T&quot;)print&#125;&#39; | grep -i vfs_fsync_range
ffffffff960837a0 T vfs_fsync_range

[root@host1 ~]# perf list | grep probe

[root@host1 ~]# perf probe vfs_fsync_range
Added new event:
  probe:vfs_fsync_range (on vfs_fsync_range)

You can now use it in all perf tools, such as:

    perf record -e probe:vfs_fsync_range -aR sleep 1

[root@host1 ~]# perf list | grep probe
  probe:vfs_fsync_range                              [Tracepoint event]
</code></pre>
<h2 id="Trace-the-user-defined-probe-event"><a href="#Trace-the-user-defined-probe-event" class="headerlink" title="Trace the user-defined probe event"></a>Trace the user-defined probe event</h2><p>At this point, we had the tracepoint for the function “vfs_fsync_range” added in perf. We are able to sample the stack trace and check the function runtime from <strong>perf script</strong> output. This can be useful because without the dynamic tracing like this, we can’t identify the overhead(runtime) for the target function. The similar tracing can be done with ftrace. Here we just study how to use perf to dynamically add a tracepoint for sampling in perf. However, based on the experiments, ftrace seems more powerful when to identify the kernel function overhead compared to perf.</p>
<p>The following commands show how to record the stack traces for the target tracepoint and how to extract the call time from it. By comparing the function call time for the differnt kernels, we could identify the possible issue in nfsd call stack.</p>
<pre><code>[root@host1 ~]#  perf record -e probe:vfs_fsync_range -aR sleep 10
[ perf record: Woken up 57 times to write data ]
[ perf record: Captured and wrote 16.284 MB perf.data (233480 samples) ]

[root@host1 ~]# ls -la perf.data
-rw------- 1 root root 17120542 Jul 13 23:50 perf.data

[root@host1 ~]#  perf record -e probe:vfs_fsync_range -g -aR sleep 10
[ perf record: Woken up 146 times to write data ]
[ perf record: Captured and wrote 38.179 MB perf.data (248546 samples) ]

[root@host1 ~]# ls -la perf.data
-rw------- 1 root root 40079506 Jul 13 23:52 perf.data

[root@host1 ~]# perf report --stdio
# To display the perf.data header info, please use --header/--header-only options.
#
#
# Total Lost Samples: 0
#
# Samples: 248K of event &#39;probe:vfs_fsync_range&#39;
# Event count (approx.): 248546
#
# Children      Self  Trace output
# ........  ........  ..................
#
   100.00%   100.00%  (ffffffff960837a0)
            |
            ---ret_from_fork_nospec_end
               kthread
               nfsd
               svc_process
               svc_process_common
               nfsd_dispatch
               nfsd4_proc_compound
               nfsd4_write
               vfs_fsync_range

[root@host1 ~]# perf script
nfsd  3592 [025]   677.464643: probe:vfs_fsync_range: (ffffffff960837a0)
        ffffffff960837a1 vfs_fsync_range+0x1 ([kernel.kallsyms])
        ffffffffc07a0b0f nfsd4_write+0x1cf ([kernel.kallsyms])
        ffffffffc07a267d nfsd4_proc_compound+0x3dd ([kernel.kallsyms])
        ffffffffc078d810 nfsd_dispatch+0xe0 ([kernel.kallsyms])
        ffffffffc0f61850 svc_process_common+0x400 ([kernel.kallsyms])
        ffffffffc0f61d13 svc_process+0xf3 ([kernel.kallsyms])
        ffffffffc078d16f nfsd+0xdf ([kernel.kallsyms])
        ffffffff95ec5c21 kthread+0xd1 ([kernel.kallsyms])
        ffffffff96593df7 ret_from_fork_nospec_end+0x0 ([kernel.kallsyms])
&lt;...&gt;
</code></pre>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://www.flamingbytes.com/blog/tuned-dynamic-adaptive-system-tuning-daemon/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/logo/FlamingBytes-icon-64x64-1.png">
      <meta itemprop="name" content="relentlesstorm">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="FlamingBytes">
      <meta itemprop="description" content="Stay hungry, stay foolish">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | FlamingBytes">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/blog/tuned-dynamic-adaptive-system-tuning-daemon/" class="post-title-link" itemprop="url">tuned - dynamic adaptive system tuning daemon</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-07-12 07:00:00" itemprop="dateCreated datePublished" datetime="2022-07-12T07:00:00-07:00">2022-07-12</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2023-10-22 11:28:20" itemprop="dateModified" datetime="2023-10-22T11:28:20-07:00">2023-10-22</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Tech/" itemprop="url" rel="index"><span itemprop="name">Tech</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Tech/Performance/" itemprop="url" rel="index"><span itemprop="name">Performance</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <blockquote>
<p>Tuned</p>
<blockquote>
<p>Tuned is a daemon that uses udev to monitor connected devices and statically and dynamically tunes system settings according to a selected profile. Tuned is distributed with a number of predefined profiles for common use cases like high throughput, low latency, or powersave. It is possible to modify the rules defined for each profile and customize how to tune a particular device. To revert all changes made to the system settings by a certain profile, you can either switch to another profile or deactivate the tuned service.</p>
</blockquote>
</blockquote>
<h2 id="Check-the-tuned-service-and-active-profile"><a href="#Check-the-tuned-service-and-active-profile" class="headerlink" title="Check the tuned service and active profile"></a>Check the tuned service and active profile</h2><pre><code>[root@host1 ~]# systemctl status tuned
● tuned.service - Dynamic System Tuning Daemon
   Loaded: loaded (/usr/lib/systemd/system/tuned.service; enabled; vendor preset: enabled)
   Active: active (running) since Tue 2022-07-12 04:52:53 UTC; 13h ago
     Docs: man:tuned(8)
           man:tuned.conf(5)
           man:tuned-adm(8)
 Main PID: 2592 (tuned)
    Tasks: 5
   Memory: 33.9M
   CGroup: /system.slice/tuned.service
           └─2592 /usr/bin/python2 -Es /usr/sbin/tuned -l -P

Jul 12 04:52:52 host1 systemd[1]: Starting Dynamic System Tuning Daemon...
Jul 12 04:52:53 host1 systemd[1]: Started Dynamic System Tuning Daemon.

[root@host1 ~]# tuned-adm list
Available profiles:
- balanced                    - General non-specialized tuned profile
- desktop                     - Optimize for the desktop use-case
- hpc-compute                 - Optimize for HPC compute workloads
- latency-performance         - Optimize for deterministic performance at the cost of increased power consumption
- network-latency             - Optimize for deterministic performance at the cost of increased power consumption, focused on low latency network performance
- network-throughput          - Optimize for streaming network throughput, generally only necessary on older CPUs or 40G+ networks
- powersave                   - Optimize for low power consumption
- throughput-performance      - Broadly applicable tuning that provides excellent performance across a variety of common server workloads
- virtual-guest               - Optimize for running inside a virtual guest
- virtual-host                - Optimize for running KVM guests
Current active profile: balanced

[root@host1 ~]# tuned-adm active
Current active profile: balanced

[root@host1 ~]# cat /sys/devices/system/cpu/cpu*/cpufreq/scaling_governor | head
powersave
powersave
&lt;omitted..&gt;
</code></pre>
<h2 id="Change-the-tuned-profile"><a href="#Change-the-tuned-profile" class="headerlink" title="Change the tuned profile"></a>Change the tuned profile</h2><pre><code>[root@host1 ~]# tuned-adm profile throughput-performance

[root@host1 ~]# tuned-adm active
Current active profile: throughput-performance

[root@host1 ~]# cat /sys/devices/system/cpu/cpu*/cpufreq/scaling_governor
performance
performance
&lt;omitted..&gt;
</code></pre>
<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><ul>
<li><a target="_blank" rel="noopener" href="https://linux.die.net/man/8/tuned">https://linux.die.net/man/8/tuned</a></li>
<li><a target="_blank" rel="noopener" href="https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/7/html/performance_tuning_guide/chap-red_hat_enterprise_linux-performance_tuning_guide-tuned">https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux&#x2F;7&#x2F;html&#x2F;performance_tuning_guide&#x2F;chap-red_hat_enterprise_linux-performance_tuning_guide-tuned</a></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <a class="extend prev" rel="prev" title="Previous page" aria-label="Previous page" href="/page/13/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/13/">13</a><span class="page-number current">14</span><a class="page-number" href="/page/15/">15</a><span class="space">&hellip;</span><a class="page-number" href="/page/27/">27</a><a class="extend next" rel="next" title="Next page" aria-label="Next page" href="/page/15/"><i class="fa fa-angle-right"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2023</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">relentlesstorm</span>
  </div>
<div class="busuanzi-count">
    <span class="post-meta-item" id="busuanzi_container_site_uv">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="Total Visitors">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-item" id="busuanzi_container_site_pv">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="Total Views">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/mist/" rel="noopener" target="_blank">NexT.Mist</a>
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>







  
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>





</body>
</html>
